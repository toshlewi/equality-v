<!-- 9e121317-49d7-48c1-b11d-145e7cc09500 efd4f91d-4b3d-47dc-9735-451225f5ef1f -->
# Equality Vanguard – 2-Day Final Execution Plan (Phased)

## Scope

Finalize all partially-done items, implement missing features, address risks, complete deployment readiness, and define post-deployment operations for a production launch in 48 hours.

## Assumptions

- Hosting: Vercel; DB: MongoDB Atlas; Storage: S3/Spaces; Payments: Stripe + M‑Pesa; Email: SendGrid/Mailgun; Mailing: Mailchimp.
- Admin exists under `src/app/admin`, APIs under `src/app/api`, models under `src/models`, libs under `src/lib`.
- Prod/staging envs available in Vercel; Stripe/M‑Pesa sandbox keys available.

## Phase 0 – Pre‑flight (1–2 hours)

- Checklist and Kickoff
- Confirm access to: Vercel, MongoDB Atlas, S3/Spaces, Stripe, M‑Pesa, Mail provider, Mailchimp, Sentry, domain DNS.
- Validate env parity on Vercel (staging vs prod) using `npm run validate:env`.
- Review current data: seed/staging content via `src/scripts/seed-initial-data.ts`.

- Branching & CI
- Create `release/launch` branch; protect `main`.
- Ensure Vercel Preview builds for PRs.

## Phase 1 – Close Partially Done (Day 1 AM)

1) Members admin management

- Files
- `src/app/admin/members/page.tsx` (list + filters + CSV export)
- `src/app/admin/members/[id]/page.tsx` (detail + actions)
- Reuse: `src/models/Member.ts`, `src/app/api/membership/route.ts`
- Tasks
- Implement paginated table (status, tier, dates). Actions: activate/cancel, resend email, export CSV.
- Add `GET /api/membership` (list) and `PATCH /api/membership/:id` (status updates)
- Wire mail confirmations via `lib/email.ts`; Mailchimp tagging via `lib/mailchimp.ts`.
- Tests
- Happy path list/filter/export; status changes; email resend.

2) Partnerships admin polish

- Files
- `src/app/admin/members/partnerships/page.tsx` (ensure filters/actions)
- APIs: `src/app/api/partnerships/route.ts`, `[id]/route.ts`
- Tasks
- Add status transitions (contacted/in_progress/declined), notes, export.
- Tests
- Create→List→Update flows; email notification to admin.

3) Donations admin + receipts

- Files
- `src/app/admin/payments/donations/page.tsx`
- `src/app/api/donations/route.ts`, `src/app/api/webhooks/stripe/route.ts`, `.../mpesa/route.ts`
- `src/lib/email.ts` (add donation receipt template)
- Tasks
- Totals by period/type; resend receipt; refund CTA (Stripe)
- Verify webhook idempotency and state transitions
- Tests
- Stripe test payment flows; M‑Pesa sandbox callback.

## Phase 2 – Implement Missing Modules (Day 1 PM)

4) Volunteer & Jobs module

- Models
- `src/models/Job.ts`, `src/models/VolunteerApplication.ts`
- APIs
- `POST/GET /api/jobs` (admin CRUD), `GET /api/jobs/[id]`
- `POST /api/volunteers/apply` (public submit + reCAPTCHA)
- Admin UI
- `src/app/admin/members/volunteers/page.tsx` (list/detail, approve/reject)
- `src/app/admin/members/jobs/page.tsx` and `.../jobs/new/page.tsx`
- Frontend
- Enhance `src/app/jobs-volunteer/page.tsx` to fetch jobs + application form
- Notifications
- Applicant confirmation + admin alert via `lib/email.ts`
- Tests
- Validation, spam control, CSV export, status updates

5) Shop admin UI

- Files
- `src/app/admin/shop/products/page.tsx`, `.../products/new/page.tsx`, `.../products/[id]/page.tsx`
- `src/app/admin/shop/orders/page.tsx`, `.../orders/[id]/page.tsx`
- APIs reuse: `products`, `orders`
- Tasks
- Product CRUD (image upload via `upload` API), category select, stock
- Orders dashboard: statuses, refund (Stripe), export
- Tests
- Product lifecycle; order refund to Stripe test

## Phase 3 – Events Enhancements (Day 2 AM)

6) Paid registration, tickets, calendar

- Files
- API reuse: `src/app/api/events/route.ts`, `[id]/route.ts`, `register/route.ts`
- Ticket email template (HTML) in `lib/email.ts`
- ICS utility `src/lib/calendar.ts` (new): generate `.ics`
- Tasks
- If paid: create Stripe Checkout/PaymentIntent with `{registrationId}` metadata; set status via webhook
- Send attendee confirmation with `.ics` attachment; include QR or code
- Optional: Google Calendar API integration behind admin setting (fallback to ICS)
- Tests
- Free vs paid paths; email/ICS contents; webhook idempotency

## Phase 4 – Settings & Logs (Day 2 AM)

7) Admin Settings & Audit Logs

- Files
- `src/models/Setting.ts`, `src/models/AuditLog.ts`
- `src/app/admin/settings/page.tsx`
- `src/app/admin/logs/audit/page.tsx`
- `src/app/api/settings/route.ts`, `src/app/api/logs/audit/route.ts`
- Tasks
- Editable settings: email sender/name, toggle Google Calendar, reCAPTCHA, payments
- Display audit logs with filters/search; ensure critical admin actions write to AuditLog
- Tests
- RBAC enforcement; settings persist and affect behavior

## Phase 5 – Emails & Notifications Coverage (Day 2 AM→PM)

8) End-to-end confirmations and admin alerts

- Flows to verify/implement
- Membership, Donation, Event Registration, Partnerships, Contact, Newsletter, Volunteer/Jobs
- Artifacts
- Transactional HTML templates (plain-text fallbacks) in `lib/email.ts`
- Ensure `lib/notifications.ts` surfaces admin in-app notices (if used) and emails
- Tests
- For each flow: success email to user + notification to admin

## Phase 6 – Security, Testing, Performance, CI/CD (Day 2 PM)

9) Security hardening

- CSP: verify Stripe, Google reCAPTCHA, Mail endpoints in `next.config.ts`
- Confirm rate limiting on public APIs; input validation via Zod/Joi
- Verify admin RBAC; secure cookies; session max-age; 2FA optional
- S3/Spaces upload: MIME/size checks, random keys, antivirus if enabled

10) Test coverage (focused)

- Add integration tests for critical flows using minimal test harness (API route tests for: membership, donations, events registration, newsletter)
- Manual e2e on staging using test accounts/cards (document outcomes)

11) Performance & UX

- Lighthouse ≥ 85; image optimization; pagination for admin tables
- DB indexes: Members(email), Orders(createdAt), Products(slug), Events(date), Publications(slug/title)

12) CI/CD & Env

- GitHub Actions: type-check, lint, selected integration tests; block merges on fail
- Vercel: ensure Preview for PRs; final Production deploy from `main`
- Secrets: distinct staging vs prod; set Stripe/M‑Pesa webhooks to Vercel URLs

## Phase 7 – Go/No-Go & Launch (End of Day 2)

- Staging sign-off checklist
- Run smoke tests across all user flows
- Verify webhooks received in logs; verify emails received and DKIM aligned
- Admin: members, donations, orders, jobs/volunteers, settings, logs view working
- Production deploy
- Merge `release/launch` → `main`; Deploy
- Run post-deploy smoke tests (membership signup, donation, event reg free/paid, newsletter, contact)

## Post-Deployment (same day)

- Monitoring & Alerts
- Enable Sentry DSN + alert rules; UptimeRobot/BetterStack health checks
- Log aggregation target (Logtail/Datadog) if configured
- Runbooks & Access
- Create runbook in repo: ops steps for refunds, resends, exports, settings
- Share access for Vercel, MongoDB, Stripe, M‑Pesa, Mail, Mailchimp, S3, Sentry
- Backups & Compliance
- Ensure MongoDB backups on; retention documented; data deletion policy noted
- Analytics
- Confirm GA4/Plausible configured and receiving events

## Environment Variables (must be set before launch)

- Database: `MONGODB_URI`
- Auth: `NEXTAUTH_SECRET`, `JWT_SECRET`
- Payments: `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET`, `MPESA_*`
- Email: `SENDGRID_API_KEY` or `MAILGUN_*`, `EMAIL_FROM`
- Mailing: `MAILCHIMP_API_KEY`, `MAILCHIMP_LIST_ID`
- reCAPTCHA: `RECAPTCHA_SITE_KEY`, `RECAPTCHA_SECRET_KEY`
- Storage: `S3_ENDPOINT`, `S3_BUCKET`, `S3_ACCESS_KEY_ID`, `S3_SECRET_ACCESS_KEY`
- Monitoring: `SENTRY_DSN`

## Acceptance Criteria (Done = Ready to Handover)

- All Get Involved modules live end-to-end with confirmations and admin visibility
- Paid flows (donations, tickets, shop) succeed in live and record in DB; receipts sent
- Admin Settings/Logs available; exports work (members, donations, orders)
- Security checks pass; webhooks functioning; Lighthouse ≥ 85 on key pages
- Staging and production smoke tests recorded with timestamps

### To-dos

- [ ] Implement Members admin list/detail/actions + list API
- [ ] Finish Partnerships admin filters/actions + email alerts
- [ ] Add donation receipt templates, totals, refund flow
- [ ] Create Jobs + Volunteer APIs, admin pages, UI form
- [ ] Build admin product CRUD and orders dashboards
- [ ] Wire paid events, confirmation email + ICS, webhook updates
- [ ] Create Admin Settings and Audit Logs pages + APIs
- [ ] Ensure confirmations + admin notifications across flows
- [ ] Harden CSP, validation, rate limits, RBAC, storage checks
- [ ] Add critical integration tests; indexes; pagination; Lighthouse
- [ ] Tighten CI/CD, preview deploys, secrets, webhooks
- [ ] Staging sign-off, production deploy, post-deploy smoke tests
- [ ] Monitoring alerts, runbooks, backups, analytics